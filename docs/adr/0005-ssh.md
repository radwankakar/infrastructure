# [How should we manage ssh access to individual machines?]
<!-- Source: https://raw.githubusercontent.com/adr/madr/master/template/template.md -->

* Status: draft
* Deciders: @eeeady @kilbergr @rahearn
* Date: 2021-06-21

Technical Story: [ADR for how to manage individual ssh access for users](https://github.com/OHS-Hosting-Infrastructure/infrastructure/issues/33) <!-- optional -->

## Table of Contents

<!-- toc -->

* [Context and Problem Statement](#context-and-problem-statement)
* [Decision Drivers](#decision-drivers-)
* [Considered Options](#considered-options)
* [Decision Outcome](#decision-outcome)
  * [Implementation details](#implementation-details)
* [Pros and Cons of the Options](#pros-and-cons-of-the-options-)
  * [Option 1: Continue sharing the same key(s)](#option-1-continue-sharing-the-same-keys)
  * [Option 2: Add individual public keys to the "correct" authorized keys file for users](#option-2-add-individual-public-keys-to-the-correct-authorized-keys-file-for-users)
  * [Option 3: Provision users with appropriate access and individual keys to each machine](#option-3-provision-users-with-appropriate-access-and-individual-keys-to-each-machine)

<!-- Regenerate with "pre-commit run -a markdown-toc" -->

<!-- tocstop -->

## Context and Problem Statement

Until the hosting team provides other methods of configuration, diagnostics, and debugging are available we need to provide access to individual servers.

Developers should have ssh access to their staging and development servers.
The headstart hosting team should have ssh access to all servers in their hosting environment.

We have been using [Principle of least privilege](https://en.wikipedia.org/wiki/Principle_of_least_privilege) to drive what access and privileges are available to a given role.

All of this access should be unique to individuals without shared credentials.

## Decision Drivers <!-- optional -->

* Individuals have least privilege access to machines.
* Commands are traceable to individual users.
* No longer transmitting the same shared ssh keys.

## Considered Options

* Continue sharing the same key(s) (drupal/centos)
* Add individual public keys to the "correct" authorized keys file for users (Drupal/centos/ubuntu)
* Provision users with appropriate access and individual keys to each machine

## Decision Outcome

Chosen option: "Provision users with appropriate access and individual keys to each machine", because this allows us to audit and manage users individually across each server in our fleet.

### Implementation details

This environment is already instrumented with Ansible so we should leverage this tooling to add new users and keys.

We'll need to copy existing Ansible configuration into a repository and use either a common module from Ansible Galaxy or common Ansible commands to configure individual users in that new repo.

The hosting team will then ensure that Ansible is run on PR merges to keep the environment up to date.

## Pros and Cons of the Options <!-- optional -->

### Option 1: Continue sharing the same key(s)

This means we keep sending the same ssh private key to folks that need access to "centos" or "drupal" users on the servers.

* Good, because it's easy to continue doing what we've been doing.
* Bad, because it is hard to audit servers for who performed what commands.
* Bad, because we have and will share the same admin key over and over again.

### Option 2: Add individual public keys to the "correct" authorized keys file for users

This means we would update the authorized keys file for existing users ("centos", "drupal", "ubuntu" etc) to accept new keys that are provided by specific known users.

* Good, because we aren't sharing keys over and over again.
* Good, because with Ansible, it's relatively easy to add new keys to the existing file.
* Bad, because it is still a little hard to audit who performed what commands.

### Option 3: Provision users with appropriate access and individual keys to each machine

This means we would add new users to each machine with individual access that can be directly audited and managed for least priviledge.

* Good, because we aren't sharing keys over and over again.
* Good, because with Ansible, it's nearly just as easy to add new users and keys.
* Bad, because we'll need to teach folks how to manage
